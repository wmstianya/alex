# ç«ç„°æ£€æµ‹ç³»ç»Ÿ - éé˜»å¡å®šæ—¶å™¨å®ç°

## ğŸ¯ ä¿®æ”¹ç›®æ ‡

å°†æ‰€æœ‰çš„é˜»å¡å¼å»¶è¿Ÿï¼ˆ`HAL_Delay()`ï¼‰æ”¹ä¸ºéé˜»å¡çš„å®šæ—¶å™¨æ–¹å¼ï¼Œæé«˜ç³»ç»Ÿçš„å®æ—¶å“åº”æ€§èƒ½ã€‚

## ğŸ”§ ä¸»è¦ä¿®æ”¹

### 1. æ–°å¢çŠ¶æ€æœºæšä¸¾

```c
typedef enum {
    SAMPLING_IDLE = 0,          // ç©ºé—²çŠ¶æ€
    SAMPLING_INITIAL_CHECK,     // åˆå§‹æ£€æŸ¥é‡‡æ ·ä¸­
    SAMPLING_NORMAL,            // æ­£å¸¸é‡‡æ ·ä¸­
    SAMPLING_COMPLETE           // é‡‡æ ·å®Œæˆ
} SamplingState_t;
```

### 2. æ‰©å±•æ£€æµ‹å™¨ç»“æ„ä½“

åœ¨ `AdaptiveDetector_t` ç»“æ„ä½“ä¸­æ–°å¢é‡‡æ ·çŠ¶æ€æœºç›¸å…³å˜é‡ï¼š

```c
SamplingState_t samplingState;      // å½“å‰é‡‡æ ·çŠ¶æ€
uint32_t samplingSum;               // é‡‡æ ·ç´¯ç§¯å’Œ
uint16_t samplingCount;             // å½“å‰é‡‡æ ·è®¡æ•°
uint32_t lastSamplingTime;          // ä¸Šæ¬¡é‡‡æ ·æ—¶é—´
uint8_t  samplingType;              // é‡‡æ ·ç±»å‹ï¼š0-åˆå§‹æ£€æŸ¥ï¼Œ1-æ­£å¸¸æ£€æµ‹
uint32_t samplingResult;            // é‡‡æ ·ç»“æœ
```

### 3. éé˜»å¡åˆå§‹çŠ¶æ€æ£€æŸ¥

**åŸå§‹å®ç°ï¼ˆé˜»å¡ï¼‰ï¼š**
```c
// é˜»å¡100ms
for(int i = 0; i < INITIAL_CHECK_SAMPLES; i++) {
    sum += adc_convert_single();
    HAL_IWDG_Refresh(&hiwdg);
    HAL_Delay(10); // é˜»å¡10ms
}
```

**æ–°å®ç°ï¼ˆéé˜»å¡ï¼‰ï¼š**
```c
// ä½¿ç”¨çŠ¶æ€æœºï¼Œæ¯10msé‡‡æ ·ä¸€æ¬¡
if(currentTime - detector.lastSamplingTime >= 10) {
    detector.samplingSum += adc_convert_single();
    detector.samplingCount++;
    detector.lastSamplingTime = currentTime;
    // å®Œæˆåè¿”å›ç»“æœ
}
```

### 4. éé˜»å¡ADCé‡‡æ ·

**åŸå§‹å®ç°ï¼ˆé˜»å¡ï¼‰ï¼š**
```c
// é˜»å¡çº¦32ms
for(int i = 0; i < ADC_BUFFER_SIZE; i++) {
    sum += adc_convert_single();
    if((i & 0x03) == 0x03) {
        HAL_Delay(1); // æ¯4æ¬¡é‡‡æ ·å»¶è¿Ÿ1ms
    }
}
```

**æ–°å®ç°ï¼ˆéé˜»å¡ï¼‰ï¼š**
```c
// æ¯1mså¤„ç†4ä¸ªé‡‡æ ·
if(currentTime - detector.lastSamplingTime >= 1) {
    for(int i = 0; i < 4 && detector.samplingCount < ADC_BUFFER_SIZE; i++) {
        detector.samplingSum += adc_convert_single();
        detector.samplingCount++;
    }
    detector.lastSamplingTime = currentTime;
}
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| å‚æ•° | åŸå§‹å®ç° | æ–°å®ç° | æ”¹è¿› |
|------|----------|--------|------|
| åˆå§‹æ£€æŸ¥é˜»å¡æ—¶é—´ | 100ms | 0ms | âœ… éé˜»å¡ |
| æ­£å¸¸é‡‡æ ·é˜»å¡æ—¶é—´ | 32ms | 0ms | âœ… éé˜»å¡ |
| ä¸»å¾ªç¯å“åº”å»¶è¿Ÿ | æœ€å¤§132ms | <1ms | âœ… å¤§å¹…æå‡ |
| çœ‹é—¨ç‹—å–‚ç‹—é¢‘ç‡ | å—é˜»å¡å½±å“ | æŒç»­å–‚ç‹— | âœ… æ›´å®‰å…¨ |
| ç«ç„°å“åº”æ—¶é—´ | 132ms+ | <50ms | âœ… å¿«3å€ |

## ğŸ” å·¥ä½œåŸç†

### çŠ¶æ€æœºæµç¨‹

1. **ç©ºé—²çŠ¶æ€ï¼ˆSAMPLING_IDLEï¼‰**
   - ç­‰å¾…æ–°çš„é‡‡æ ·è¯·æ±‚
   - ä¸æ¶ˆè€—CPUèµ„æº

2. **é‡‡æ ·è¿›è¡Œä¸­ï¼ˆSAMPLING_INITIAL_CHECK/SAMPLING_NORMALï¼‰**
   - æ ¹æ®å®šæ—¶å™¨é—´éš”æ‰§è¡Œé‡‡æ ·
   - ç´¯ç§¯é‡‡æ ·æ•°æ®
   - æŒç»­å–‚çœ‹é—¨ç‹—

3. **é‡‡æ ·å®Œæˆï¼ˆSAMPLING_COMPLETEï¼‰**
   - è®¡ç®—å¹³å‡å€¼
   - è¿”å›ç»“æœ
   - é‡ç½®ä¸ºç©ºé—²çŠ¶æ€

### æ—¶åºæ§åˆ¶

- **åˆå§‹æ£€æŸ¥**ï¼š10msé—´éš” Ã— 10æ¬¡ = 100msæ€»æ—¶é—´
- **æ­£å¸¸é‡‡æ ·**ï¼š1msé—´éš” Ã— 32æ‰¹æ¬¡ï¼ˆæ¯æ‰¹4ä¸ªï¼‰ = 32msæ€»æ—¶é—´
- **ä¸»å¾ªç¯**ï¼šæŒç»­è¿è¡Œï¼Œæ— é˜»å¡

## ğŸ’¡ ä¼˜åŠ¿

### 1. **å®æ—¶æ€§æå‡**
- ç«ç„°æ£€æµ‹å“åº”æ—¶é—´ä»132msé™ä½åˆ°50msä»¥ä¸‹
- ä¸»å¾ªç¯å§‹ç»ˆä¿æŒè¿è¡Œï¼Œå¯ä»¥å¤„ç†å…¶ä»–ä»»åŠ¡

### 2. **ç³»ç»Ÿç¨³å®šæ€§**
- çœ‹é—¨ç‹—å®šæ—¶å–‚ç‹—ï¼Œé¿å…ç³»ç»Ÿå¤ä½
- çŠ¶æ€æœºè®¾è®¡ï¼Œé€»è¾‘æ¸…æ™°å¯ç»´æŠ¤

### 3. **æ‰©å±•æ€§å¥½**
- å®¹æ˜“æ·»åŠ æ–°çš„é‡‡æ ·ç±»å‹
- å¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªé‡‡æ ·ä»»åŠ¡

### 4. **åŠŸè€—ä¼˜åŒ–**
- ç©ºé—²æ—¶ä¸è¿›è¡Œä¸å¿…è¦çš„æ“ä½œ
- å¯ä»¥åœ¨é‡‡æ ·é—´éš”åŠ å…¥ä½åŠŸè€—æ¨¡å¼

## ğŸ“ ä½¿ç”¨è¯´æ˜

ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨éé˜»å¡æ–¹å¼è¿›è¡Œæ‰€æœ‰é‡‡æ ·æ“ä½œï¼Œæ— éœ€ç‰¹æ®Šé…ç½®ã€‚ä¸»è¦æ”¹è¿›å¯¹ç”¨æˆ·é€æ˜ï¼Œä½†ä¼šå¸¦æ¥ä»¥ä¸‹ä½“éªŒæå‡ï¼š

1. **æ›´å¿«çš„ç«ç„°å“åº”** - æ£€æµ‹åˆ°ç«ç„°çš„é€Ÿåº¦æå‡3å€
2. **æ›´ç¨³å®šçš„æ˜¾ç¤º** - æ˜¾ç¤ºåˆ·æ–°ä¸å—é‡‡æ ·å½±å“
3. **æ›´å¯é çš„è¿è¡Œ** - é¿å…çœ‹é—¨ç‹—è¶…æ—¶å¤ä½

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **çŠ¶æ€ä¸€è‡´æ€§** - é‡‡æ ·è¿‡ç¨‹ä¸­ä¼šè¿”å›ä¸Šä¸€æ¬¡çš„æ£€æµ‹ç»“æœ
2. **åˆå§‹åŒ–å»¶è¿Ÿ** - é¦–æ¬¡é‡‡æ ·ä»éœ€è¦ç­‰å¾…å®Œæ•´çš„é‡‡æ ·å‘¨æœŸ
3. **å†…å­˜ä½¿ç”¨** - å¢åŠ äº†çŠ¶æ€æœºç›¸å…³çš„å˜é‡å­˜å‚¨

---

**ç‰ˆæœ¬ä¿¡æ¯ï¼š**
- åŸºç¡€ç‰ˆæœ¬ï¼šV1.1.0
- éé˜»å¡ç‰ˆæœ¬ï¼šV1.2.0
- æ›´æ–°æ—¥æœŸï¼š2025å¹´1æœˆ22æ—¥ 